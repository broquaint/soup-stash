$LOAD_PATH.unshift '../lib'

require 'soupstash/ingestlogfile'
require 'net/tailhttp'

#logfile_uri = 'http://localhost:8085/dev/logfile-test/logfile'
logfile_uri = 'http://dobrazupa.org/meta/0.11/logfile'

ingester = IngestLogfile.new
parser   = IngestLogfile::Parser.new

puts "Watching #{logfile_uri}"
begin
  Net::TailHTTP.for_uri(logfile_uri, 60) do |response|
    logfile_lines = response.body.split("\n")
    parser.import_from(logfile_lines) do |game|
      ingester.commit_game(game)
    end
  end
rescue Interrupt
  parser.finish_parsing
end
